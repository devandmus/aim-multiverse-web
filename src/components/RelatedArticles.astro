---
import type { CollectionEntry } from "astro:content";
import {
    getRandomSuggestions,
    getRelatedArticles,
} from "../utils/getRelatedArticles";

export interface Props {
    currentPost: CollectionEntry<"blog"> | null;
    allPosts: CollectionEntry<"blog">[];
    type?: "related" | "random" | "category";
    category?: string;
    maxResults?: number;
    title?: string;
}

const {
    currentPost,
    allPosts,
    type = "related",
    category,
    maxResults = 3,
    title,
} = Astro.props;

let articles;

if (type === "random" || !currentPost) {
    articles = getRandomSuggestions(allPosts, currentPost?.slug, maxResults);
} else {
    switch (type) {
        case "related":
            articles = getRelatedArticles(currentPost, allPosts, maxResults);
            break;
        case "category":
            articles = getRelatedArticles(
                currentPost,
                allPosts.filter((post) => post.data.category === category),
                maxResults,
            );
            break;
        default:
            articles = getRelatedArticles(currentPost, allPosts, maxResults);
    }
}

const displayTitle =
    title || (type === "related" ? "Artículos Relacionados" : "Más Artículos");
---

{
    articles.length > 0 && (
        <section class="related-articles bg-base-darker border border-neon-cyan rounded-xl p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-base-light">
                    {displayTitle}
                </h3>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-base-grey">
                        {articles.length} artículo
                        {articles.length !== 1 ? "s" : ""}
                    </span>
                    <svg
                        class="w-5 h-5 text-neon-cyan"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M13 7l5 5m0 0l-5 5m5-5H6"
                        />
                    </svg>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {articles.map((article) => (
                    <a
                        href={article.url}
                        class="related-article-card bg-base-dark border border-neon-cyan/50 rounded-lg p-4 hover:border-neon-cyan hover:shadow-lg hover:shadow-neon-cyan/10 transition-all duration-300 group"
                    >
                        <div class="mb-3">
                            <div class="flex items-center gap-2 mb-2">
                                {(article.tags || [])
                                    .slice(0, 2)
                                    .map((tag: string) => (
                                        <span class="px-2 py-1 bg-neon-cyan/20 text-neon-cyan text-xs rounded-full">
                                            {tag}
                                        </span>
                                    ))}
                                {article.featured && (
                                    <span class="px-2 py-1 bg-neon-pink/20 text-neon-pink text-xs rounded-full font-semibold">
                                        ⭐ Destacado
                                    </span>
                                )}
                            </div>
                            <h4 class="text-base font-semibold text-base-light group-hover:text-neon-pink transition-colors line-clamp-2 mb-2">
                                {article.title}
                            </h4>
                        </div>

                        <p class="text-base-grey text-sm line-clamp-2 mb-4">
                            {article.description}
                        </p>

                        <div class="flex items-center justify-between text-xs text-base-grey">
                            <div class="flex items-center gap-2">
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                    />
                                </svg>
                                <span>{article.readingTime || "N/A"}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <svg
                                    class="w-4 h-4"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                                    />
                                </svg>
                                <span>{article.category || "General"}</span>
                            </div>
                        </div>

                        <div class="mt-3 pt-3 border-t border-base-grey/20">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-base-grey">
                                    {new Date(article.date).toLocaleDateString(
                                        "es-ES",
                                        {
                                            year: "numeric",
                                            month: "short",
                                            day: "numeric",
                                        },
                                    )}
                                </span>
                                <div class="flex items-center gap-1 text-neon-cyan group-hover:gap-2 transition-all">
                                    <span class="text-xs font-medium">
                                        Leer más
                                    </span>
                                    <svg
                                        class="w-3 h-3"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 5l7 7-7 7"
                                        />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </a>
                ))}
            </div>

            {type === "related" && articles.length > 0 && (
                <div class="mt-6 pt-4 border-t border-base-grey/20">
                    <div class="flex items-center justify-center">
                        <a
                            href="/blog"
                            class="inline-flex items-center gap-2 text-neon-cyan hover:text-neon-pink transition-colors text-sm font-medium"
                        >
                            <span>Ver todos los artículos</span>
                            <svg
                                class="w-4 h-4"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M13 7l5 5m0 0l-5 5m5-5H6"
                                />
                            </svg>
                        </a>
                    </div>
                </div>
            )}
        </section>
    )
}

<style>
    .related-article-card {
        transform: translateY(0);
        transition: all 0.3s ease;
    }

    .related-article-card:hover {
        transform: translateY(-4px);
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .related-articles {
        position: relative;
    }

    .related-articles::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, var(--neon-cyan), var(--neon-pink));
        border-radius: inherit;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .related-articles:hover::before {
        opacity: 0.1;
    }
</style>
